name: Post-merge validation

on:
  push:
    branches: [ main, test-main ]

jobs:
  squash-check:
    name: Check Commits Are Squashed
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check squash merge
        run: |
          # Check that only one commit was added to main
          PREVIOUS_COMMIT=$(git rev-parse HEAD~1)
          COMMITS_ADDED=$(git rev-list --count $PREVIOUS_COMMIT..HEAD)

          echo "Previous commit: $(git rev-parse --short $PREVIOUS_COMMIT)"
          echo "Current commit: $(git rev-parse --short HEAD)"
          echo "Commits added: $COMMITS_ADDED"

          if [ $COMMITS_ADDED -ne 1 ]; then
            echo "âŒ Merge was not squashed! $COMMITS_ADDED commits were added to main"
            echo "Please use 'Squash and merge' when merging PRs"
            exit 1
          fi

          echo "âœ… Merge was properly squashed (1 commit added)"

          # Validate the commit message format
          MESSAGE=$(git log --format=%s -n 1 HEAD)
          echo "Merged commit message: $MESSAGE"

          SCHEMA_REGEX="^(ğŸ¨|âš¡ï¸|ğŸ”¥|ğŸ›|ğŸš‘ï¸|âœ¨|ğŸ“|ğŸš€|ğŸ’„|ğŸ‰|âœ…|ğŸ”’ï¸|ğŸ”|ğŸ”–|ğŸš¨|ğŸš§|ğŸ’š|â¬‡ï¸|â¬†ï¸|ğŸ“Œ|ğŸ‘·|ğŸ“ˆ|â™»ï¸|â•|â–|ğŸ”§|ğŸ”¨|ğŸŒ|âœï¸|ğŸ’©|âªï¸|ğŸ”€|ğŸ“¦ï¸|ğŸ‘½ï¸|ğŸšš|ğŸ“„|ğŸ’¥|ğŸ±|â™¿ï¸|ğŸ’¡|ğŸ»|ğŸ’¬|ğŸ—ƒï¸|ğŸ”Š|ğŸ”‡|ğŸ‘¥|ğŸš¸|ğŸ—ï¸|ğŸ“±|ğŸ¤¡|ğŸ¥š|ğŸ™ˆ|ğŸ“¸|âš—ï¸|ğŸ”ï¸|ğŸ·ï¸|ğŸŒ±|ğŸš©|ğŸ¥…|ğŸ’«|ğŸ—‘ï¸|ğŸ›‚|ğŸ©¹|ğŸ§|âš°ï¸|ğŸ§ª|ğŸ‘”|ğŸ©º|ğŸ§±|ğŸ§‘â€ğŸ’»|ğŸ’¸|ğŸ§µ|ğŸ¦º|âœˆï¸)\\([a-z0-9:-]+\\) [a-z].{1,50}"

          if ! echo "$MESSAGE" | grep -qE "$SCHEMA_REGEX"; then
            echo "âŒ Merged commit has invalid format: $MESSAGE"
            echo "Required format: <emoji>(<scope>) <subject>"
            exit 1
          fi

          echo "âœ… Merged commit format is valid"
