#!/usr/bin/env bash

set -eo pipefail

declare DOCKER_USER
DOCKER_UID="$(id -u)"
DOCKER_GID="$(id -g)"


DOCKER_USER="${DOCKER_UID}:${DOCKER_GID}"

extra_args=()
# Prevent 'the input device is not a TTY' error from `docker compose run`
# by disabling TTY when standard output is not a TTY
if [[ "$1" == run && "$(tty 2>/dev/null)" == "not a tty" ]]; then
  extra_args=(run --no-TTY)
  shift
fi

# On macOS, GID 20 is reserved for the "staff" group which may cause permission issues
if [[ "$OSTYPE" == "darwin"* ]] && [[ "$DOCKER_GID" -le "20" ]]; then
    DOCKER_GID="1000"
fi


DOCKER_USER=${DOCKER_USER} \
  DOCKER_UID=${DOCKER_UID} \
  DOCKER_GID=${DOCKER_GID} \
  docker compose "${extra_args[@]}" "$@"
